import{G as e,d as t,c as r,e as n,R as a,N as i,f as o,j as s,g as l,u as c,a as d,t as u,h as m,i as p,k as g,L as h,l as v,m as f,n as x,M as y,o as b,p as w}from"./index-CcWQktJ4.js";import{r as k,R as j,b as M,f as S}from"./react-vendor-DDf5lLMV.js";import{m as N}from"./map-vendor-BmUuPJTJ.js";import{g as C,h as _}from"./arScenes-Cl0RNYCS.js";import"./state-vendor-DDdbs_L0.js";import"./directus-vendor-CBm5TYxg.js";const I=(e,t)=>{const r=(e=>{switch(e){case"driving":return 80;case"cycling":return 15;default:return 5}})(t);return e/r*60},E=e=>"boolean"==typeof e?`${e}`:0===e?"0":e,z=o,L=(R="inline-flex items-center justify-center whitespace-nowrap rounded-full text-base font-semibold ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 active:scale-[0.97]",A={variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90"},size:{default:"h-12 px-6 py-3",sm:"h-10 px-4 py-2 text-sm",lg:"h-14 px-8 py-4 text-lg",icon:"h-12 w-12"}},defaultVariants:{variant:"default",size:"default"}},e=>{var t;if(null==(null==A?void 0:A.variants))return z(R,null==e?void 0:e.class,null==e?void 0:e.className);const{variants:r,defaultVariants:n}=A,a=Object.keys(r).map(t=>{const a=null==e?void 0:e[t],i=null==n?void 0:n[t];if(null===a)return null;const o=E(a)||E(i);return r[t][o]}),i=e&&Object.entries(e).reduce((e,t)=>{let[r,n]=t;return void 0===n||(e[r]=n),e},{}),o=null==A||null===(t=A.compoundVariants)||void 0===t?void 0:t.reduce((e,t)=>{let{class:r,className:a,...o}=t;return Object.entries(o).every(e=>{let[t,r]=e;return Array.isArray(r)?r.includes({...n,...i}[t]):{...n,...i}[t]===r})?[...e,r,a]:e},[]);return z(R,a,o,null==e?void 0:e.class,null==e?void 0:e.className)});var R,A;const T=k.forwardRef(({className:e,variant:t,size:r,asChild:n=!1,...a},i)=>s.jsx("button",{className:l(L({variant:t,size:r,className:e})),ref:i,...a}));T.displayName="Button";const O={duration:10},P=[{duration:15,intensity:"light"},{duration:10,intensity:"medium"}],$=[{duration:30,intensity:"heavy"},{duration:20,intensity:"medium"}],D={duration:20},H={duration:15},F=()=>"vibrate"in navigator,G=e=>{F()&&navigator.vibrate(e.duration)},W=e=>{if(!F())return;const t=e.map(e=>e.duration);navigator.vibrate(t)},B=()=>G(O),V=({poi:e,currentLang:t,isNavigating:r,hasArrived:n,navigationDistance:a,navigationTime:i,onStartRoute:o,onCancelRoute:l,onClose:v,onMinimize:f,isLoading:x,externalMinimize:y})=>{var b,w,j,M;const[S,N]=k.useState("expanded"),[I,E]=k.useState(!1),[z,L]=k.useState(!1),R=k.useRef(null),A=k.useRef(null),O=k.useRef(Date.now()),{visitedLocations:F}=c(),V=d(t);k.useEffect(()=>{N("expanded")},[e.id]),k.useEffect(()=>{y&&(r?(N("minimized"),null==f||f()):(N("closed"),null==v||v()))},[y,r,v,f]),k.useEffect(()=>{n&&"minimized"===S&&N("expanded")},[n,S]),k.useEffect(()=>{if(!R.current)return;const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(L(!0),e.disconnect())})},{threshold:.1});return e.observe(R.current),()=>e.disconnect()},[]);const U=k.useCallback(()=>{E(!0)},[]),q=k.useCallback(()=>{W(P);const{markLocationVisited:r}=c.getState();r(e.id);const n="string"==typeof e.id?parseInt(e.id):e.id;u("ar_session_start",{poi_id:n,poi_name:e.name[t]||e.name.en});const a=Date.now();sessionStorage.setItem("ar-current-poi",String(n)),sessionStorage.setItem("ar-session-start-ts",String(a)),m(n);const i=C(String(e.id));i&&(window.location.href=i)},[e.id,e.name,t]),Z=k.useCallback(()=>{G(D);const t=a?a/1e3:void 0;p(e.id,t),o(),N("minimized")},[e.id,a,o]),Y=k.useCallback(()=>{W($);const t=Math.floor((Date.now()-O.current)/1e3);g(e.id);const r="string"==typeof e.id?parseInt(e.id):e.id;u("route_cancelled",{poi_id:r,duration_seconds:t,distance_km:a?a/1e3:void 0}),l(),N("closed"),null==v||v()},[e.id,a,l,v]),X=k.useCallback(()=>{if(B(),n||!r)return N("closed"),void(null==v||v());r&&(N("minimized"),null==f||f())},[n,r,v,f]),K=k.useCallback(()=>{G(H),N("expanded")},[]),J=e.has_ar&&_(String(e.id)),Q=F.includes(e.id),ee=e.image?`https://datacalella.metaversotechnologies.com/assets/${e.image}`:null;return"minimized"===S?s.jsx("div",{ref:A,className:"location-card-minimized visible",onClick:K,children:s.jsxs("div",{className:"location-card-minimized-content",children:[s.jsx("span",{className:"location-card-minimized-title",children:e.name[t]}),s.jsx("div",{className:"location-card-minimized-arrow",children:s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:s.jsx("path",{d:"M18 15l-6-6-6 6"})})})]})}):"closed"===S?null:s.jsxs("div",{ref:A,className:"location-card",onClick:e=>e.stopPropagation(),children:[ee&&s.jsxs("div",{className:"location-card-image",children:[s.jsx("img",{ref:R,src:z?ee:void 0,alt:e.name[t],onLoad:U,className:"location-card-image-img",style:{opacity:I?1:0,transition:"opacity 0.3s ease"},onError:e=>e.target.style.display="none"}),!I&&s.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(90deg, var(--bg-gray) 25%, #e5e7eb 50%, var(--bg-gray) 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite",display:"flex",justifyContent:"center"},children:s.jsx(h,{size:"md"})}),s.jsx(T,{variant:"ghost",size:"icon",onClick:e=>{e.stopPropagation(),X()},className:"absolute top-2 right-2 h-8 w-8 rounded-full shadow-md",style:{backgroundColor:"var(--btn-primary-bg)",color:"var(--btn-primary-text)"},"aria-label":V("close"),children:s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 12 12",fill:"none",children:s.jsx("path",{d:"M1 1L11 11M11 1L1 11",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round"})})})]}),s.jsxs("div",{className:"location-card-content",style:n||Q?{paddingBottom:"12px",paddingTop:"18px",gap:"6px"}:void 0,children:[s.jsx("h2",{className:"location-card-title",children:e.name[t]}),e.adress&&s.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.adress)}`,target:"_blank",rel:"noopener noreferrer",style:{display:"inline-flex",alignItems:"center",gap:"4px",marginBottom:"var(--space-sm)",textDecoration:"none",color:"var(--text-light)",fontSize:"0.875rem"},onMouseEnter:e=>{e.currentTarget.style.color="var(--primary)",B()},onMouseLeave:e=>{e.currentTarget.style.color="var(--text-light)"},children:[s.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{flexShrink:0},children:[s.jsx("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),s.jsx("circle",{cx:"12",cy:"10",r:"3"})]}),s.jsx("span",{style:{textDecoration:"underline",textDecorationColor:"rgba(0,0,0,0.2)"},children:e.adress})]}),s.jsx("p",{className:"location-card-description",children:e.description[t]}),x&&s.jsxs("div",{style:{padding:"var(--space-sm)",marginBottom:"var(--space-md)",background:"var(--primary-light)",borderRadius:"var(--radius-md)",display:"flex",alignItems:"center",gap:"var(--space-sm)"},children:[s.jsx(h,{size:"sm"}),s.jsx("span",{children:V("calculatingRoute")})]}),r&&null!==a&&s.jsx("div",{className:"location-card-navigation",children:s.jsxs("div",{className:"location-card-navigation-info",children:[s.jsxs("div",{style:{flex:1},children:[s.jsx("div",{style:{fontSize:"0.65rem",color:"var(--text-light)",marginBottom:"2px"},children:V("distance")}),s.jsx("div",{className:"location-card-navigation-distance",children:(re=a,((e,t)=>e<1?`${Math.round(1e3*e)} ${t.meters}`:`${e.toFixed(2)} ${t.km}`)(re,{meters:V("meters"),km:V("km"),min:V("min"),hour:V("hour"),hours:V("hours")}))})]}),null!==i&&s.jsxs("div",{style:{flex:1},children:[s.jsx("div",{style:{fontSize:"0.65rem",color:"var(--text-light)",marginBottom:"2px"},children:V("estimatedTime")}),s.jsx("div",{className:"location-card-navigation-time",children:(te=i,((e,t)=>{if(e<60)return`${Math.round(e)} ${t.min}`;{const r=Math.floor(e/60),n=Math.round(e%60);return 0===n?1===r?`1 ${t.hour}`:`${r} ${t.hours}`:`${r} ${1===r?t.hour:t.hours} ${n} ${t.min}`}})(te,{meters:V("meters"),km:V("km"),min:V("min"),hour:V("hour"),hours:V("hours")}))})]})]})}),s.jsxs("div",{className:"location-card-actions",style:n||Q?{gap:"10px",marginTop:"8px"}:void 0,children:[!r&&!n&&s.jsx(T,{onClick:Z,className:"location-card-button w-full","aria-label":(null==(w=null==(b=V("startNavigation"))?void 0:b.replace)?void 0:w.call(b,"{location}",e.name[t]||"Location"))||V("startNavigation"),children:V("startRoute")}),r&&!n&&s.jsx(T,{onClick:Y,className:"location-card-button w-full","aria-label":V("cancelNavigation"),children:V("cancelRoute")}),n&&J&&s.jsxs(s.Fragment,{children:[s.jsx(T,{onClick:q,className:"location-card-button-ar w-full","aria-label":(null==(M=null==(j=V("startARExperience"))?void 0:j.replace)?void 0:M.call(j,"{location}",e.name[t]||"Location"))||V("startARExperience"),children:V("startAR")}),s.jsx(T,{onClick:X,className:"location-card-button-secondary w-full","aria-label":V("closeLocationCard"),children:V("close")})]}),n&&!J&&s.jsx(T,{onClick:X,className:"location-card-button-secondary w-full","aria-label":V("closeLocationCard"),children:V("close")}),Q&&!n&&!r&&s.jsx(T,{onClick:X,className:"location-card-button-secondary w-full",style:n||Q?{padding:"12px 18px",fontSize:"0.95rem"}:void 0,"aria-label":V("closeLocationCard"),children:V("close")})]}),Q&&!n&&s.jsxs("div",{className:"location-card-badge",style:{marginTop:"var(--space-sm)",alignSelf:"center",background:"rgba(34, 197, 94, 0.1)",color:"#22c55e",display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",fontSize:"0.9rem",width:"100%",borderRadius:"9999px",marginLeft:"auto",marginRight:"auto",textAlign:"center"},children:[s.jsx("span",{children:"‚úì"}),V("visited")]}),n&&s.jsxs("div",{className:"location-card-badge",style:{marginTop:"var(--space-sm)",alignSelf:"center",background:"rgba(34, 197, 94, 0.1)",color:"#22c55e",display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",fontSize:"0.9rem",width:"100%",borderRadius:"9999px",marginLeft:"auto",marginRight:"auto",textAlign:"center"},children:[s.jsx("span",{children:"‚úì"}),V("youveArrived")]})]})]});var te,re},U=k.createContext(null),q=({open:e=!1,onOpenChange:t,children:r})=>{const[n,a]=k.useState(e),i=void 0!==e?e:n,o=t||a;return k.useEffect(()=>{void 0!==e&&a(e)},[e]),s.jsx(U.Provider,{value:{open:i,onOpenChange:o},children:r})},Z=k.forwardRef(({className:e,children:t,onInteractOutside:r,...n},a)=>{const{open:i,onOpenChange:o}=(()=>{const e=k.useContext(U);if(!e)throw new Error("Dialog components must be used within a Dialog");return e})(),c=k.useRef(null);return k.useImperativeHandle(a,()=>c.current),k.useEffect(()=>{const e=e=>{"Escape"===e.key&&o(!1)},t=e=>{c.current&&!c.current.contains(e.target)&&(o(!1),null==r||r())};return i&&(document.addEventListener("keydown",e),document.addEventListener("mousedown",t),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.removeEventListener("mousedown",t),document.body.style.overflow=""}},[i,o,r]),i?s.jsxs("div",{className:"fixed inset-0 z-9999 flex items-center justify-center",children:[s.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm animate-fade-in","aria-hidden":"true"}),s.jsx("div",{ref:c,className:l("relative z-50 w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-2xl border bg-card p-6 shadow-2xl animate-scale-in",e),...n,children:t})]}):null});Z.displayName="DialogContent";const Y=({className:e,...t})=>s.jsx("div",{className:l("flex flex-col space-y-1.5 text-center sm:text-left",e),...t});Y.displayName="DialogHeader";const X=k.forwardRef(({className:e,...t},r)=>s.jsx("h2",{ref:r,className:l("text-2xl font-semibold leading-none tracking-tight",e),...t}));X.displayName="DialogTitle";const K=k.forwardRef(({className:e,...t},r)=>s.jsx("p",{ref:r,className:l("text-sm text-muted-foreground",e),...t}));K.displayName="DialogDescription";const J=({isOpen:e,onClose:t,qrImageUrl:r,congratsText:n,buttonText:a,currentLang:i})=>{const[o,l]=k.useState(!1),c=d(i);k.useEffect(()=>{if(e){const e=setTimeout(()=>l(!0),10);return()=>clearTimeout(e)}l(!1)},[e]);const u=n.split("\n").map((e,t)=>s.jsxs(j.Fragment,{children:[e,t<n.split("\n").length-1&&s.jsx("br",{})]},t));return s.jsxs(q,{open:e,onOpenChange:e=>!e&&t(),children:[s.jsx(Z,{className:"sm:max-w-105 w-[calc(100vw-2rem)] max-h-[80vh] overflow-hidden p-0 gap-0 bg-white",onInteractOutside:()=>{},children:s.jsxs("div",{className:"flex flex-col overflow-y-auto max-h-[80vh]",children:[r&&s.jsx("div",{className:"flex justify-center items-center pt-6 px-6 pb-3",children:s.jsx("img",{src:r,alt:c("qrCode"),className:"w-40 h-40 object-contain transition-all duration-500",style:{transform:o?"scale(1)":"scale(0.9)",opacity:o?1:0}})}),s.jsxs(Y,{className:"px-10 pb-6 space-y-2",children:[s.jsx(X,{className:"text-center text-lg font-semibold text-foreground",children:"Congratulations!"}),s.jsx(K,{className:"text-center text-sm leading-relaxed text-muted-foreground px-2",children:u})]})]})}),s.jsxs("div",{className:"absolute top-[calc(100%+16px)] left-1/2 -translate-x-1/2 z-50 flex flex-col gap-3",children:[s.jsx(T,{onClick:t,className:"w-50 rounded-full bg-(--btn-primary-bg)! text-(--btn-primary-text)! hover:bg-(--btn-primary-bg-hover)! font-semibold shadow-lg hover:shadow-xl transition-all duration-200 hover:-translate-y-0.5 h-12 border-0",children:a}),s.jsx("button",{onClick:t,className:"text-white/80 hover:text-white text-sm font-medium transition-colors",children:"Close"})]})]})},Q=e=>{const t=(()=>{const e=window.innerWidth;return{width:e,height:window.innerHeight,isMobile:e<768,isTablet:e>=768&&e<1024,isDesktop:e>=1024}})(),r=t.isMobile?"95vw":t.isTablet?"85vw":"80vw",n={mobile:{circleSize:Math.max(32,Math.min(44,Math.floor(t.width/(e+3)))),circleGap:8,lineHeight:6,fontSize:"0.75rem",padding:{horizontal:"1rem",vertical:"0.75rem"}},tablet:{circleSize:Math.max(40,Math.min(56,Math.floor(t.width/(e+4)))),circleGap:12,lineHeight:7,fontSize:"0.875rem",padding:{horizontal:"1.5rem",vertical:"1rem"}},desktop:{circleSize:Math.max(44,Math.min(60,Math.floor(t.width/(e+5)))),circleGap:16,lineHeight:8,fontSize:"1rem",padding:{horizontal:"2rem",vertical:"1.25rem"}}},a=t.isMobile?n.mobile:t.isTablet?n.tablet:n.desktop;return e>10&&(a.circleSize=Math.max(28,a.circleSize-4),a.circleGap=Math.max(6,a.circleGap-2)),{...a,containerWidth:r}},ee=({visitedCount:e,totalCount:t,currentLang:r,onCircleClick:n})=>{const{isMenuOpen:a,completionGuide:i,hasSeenCompletion:o,setHasSeenCompletion:l}=c(),u=d(r),[m,p]=k.useState(!1),[g,h]=k.useState(!1),v=k.useMemo(()=>Q(t),[t]),f=k.useMemo(()=>(e=>{const t=Q(e);return{"--circle-size":`${t.circleSize}px`,"--circle-gap":`${t.circleGap}px`,"--line-height":`${t.lineHeight}px`,"--circle-font-size":t.fontSize,"--progress-padding-x":t.padding.horizontal,"--progress-padding-y":t.padding.vertical,"--progress-width":t.containerWidth}})(t),[t]),x=k.useMemo(()=>0===t?0:Math.round(e/t*100),[e,t]),y=k.useMemo(()=>t>0&&e===t,[e,t]),b=k.useMemo(()=>Array.from({length:t},(e,t)=>t+1),[t]),w=k.useCallback((e,t)=>{n&&("vibrate"in navigator&&navigator.vibrate(50),n(e,t))},[n]),j=k.useCallback(r=>{const n=e>=r;return n?`Location ${r} of ${t}, visited`:n?`Location ${r} of ${t}, not visited`:`Location ${r} of ${t}, not visited. Press Enter to view details.`},[e,t]),M=k.useMemo(()=>b.map(t=>{const r=e===t;return{key:`progress-step-${t}`,num:t,isVisited:e>=t,isClickable:!0,isCurrentStep:r,ariaLabel:j(t),tabIndex:0,role:"button",ariaCurrent:r?"step":void 0}}),[b,e,j]);if(k.useEffect(()=>{y&&!o&&!g&&i&&(p(!0),h(!0))},[y,o,g,i]),a)return null;const S=(null==i?void 0:i.translations[r])||"Congratulations! You've completed all locations!",N=u("close");return s.jsxs(s.Fragment,{children:[s.jsxs("section",{className:"progress-bar","aria-label":u("locationVisitProgress"),style:f,children:[s.jsxs("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",style:{position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"},children:["Progress: ",e," out of ",t," locations visited. ",x,"% complete."]}),s.jsx("div",{className:"progress-bar__title",children:s.jsx("h2",{className:"progress-bar__title-text",id:"progress-title",children:u("currentProgress")})}),s.jsxs("div",{className:"progress-bar__track",role:"group","aria-labelledby":"progress-title","aria-describedby":"progress-status",children:[s.jsxs("div",{id:"progress-status",className:"sr-only",style:{position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"},children:[e," of ",t," locations visited"]}),s.jsx("div",{role:"progressbar","aria-valuenow":e,"aria-valuemin":0,"aria-valuemax":t,"aria-label":u("visitProgress").replace("{visited}",e.toString()).replace("{total}",t.toString()),className:"progress-bar__items",children:M.map((t,r)=>{const n=e>=r+2,a=r===M.length-1;return s.jsxs("div",{className:"progress-bar__item-wrapper",children:[s.jsx("div",{className:`progress-bar__circle ${t.isVisited?"progress-bar__circle--visited":"progress-bar__circle--unvisited"} ${t.isClickable?"progress-bar__circle--clickable":""}`,onClick:()=>w(t.num,t.isVisited),onKeyDown:e=>((e,t,r)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),w(t,r))})(e,t.num,t.isVisited),role:t.role,tabIndex:t.tabIndex,"aria-label":t.ariaLabel,"aria-current":t.ariaCurrent,style:{cursor:t.isClickable?"pointer":"default",width:`${v.circleSize}px`,height:`${v.circleSize}px`,minWidth:`${v.circleSize}px`,minHeight:`${v.circleSize}px`,fontSize:v.fontSize},children:s.jsx("span",{"aria-hidden":"true",children:t.num})}),!a&&s.jsx("div",{className:"progress-bar__segment "+(n?"progress-bar__segment--visited":"progress-bar__segment--unvisited"),"aria-hidden":"true"})]},t.key)})})]})]}),i&&s.jsx(J,{isOpen:m,onClose:()=>{p(!1),l(!0)},qrImageUrl:i.qr_image_url,congratsText:S,buttonText:N,currentLang:r})]})},te=({isOpen:e,onClose:t,characterName:r,characterImageUrl:n,welcomeText:a,buttonText:i})=>{const[o,l]=k.useState(!1);k.useEffect(()=>{if(e){const e=setTimeout(()=>l(!0),10);return()=>clearTimeout(e)}l(!1)},[e]);const c=a.split("\n").map((e,t)=>s.jsxs(j.Fragment,{children:[e,t<a.split("\n").length-1&&s.jsx("br",{})]},t)),d=(()=>{const e=a.length;return e<250?"1rem":e<450?"0.95rem":e<650?"0.9rem":"0.85rem"})();return e?s.jsxs("div",{className:"fixed inset-0 z-9999 flex items-center justify-center",children:[s.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm","aria-hidden":"true",onClick:t}),s.jsxs("div",{className:"relative flex flex-col items-center gap-6 max-h-[90vh] px-4",children:[s.jsx("div",{className:"relative z-50 sm:max-w-105 w-full max-w-[calc(100vw-2rem)] max-h-[70vh] overflow-y-auto rounded-2xl bg-white shadow-2xl",style:{transform:o?"scale(1)":"scale(0.95)",opacity:o?1:0,transition:"all 0.3s ease-out"},children:s.jsxs("div",{className:"flex flex-col py-6 px-8",children:[n&&s.jsx("div",{className:"flex justify-center items-center mb-4",children:s.jsx("img",{src:n,alt:r,className:"w-24 h-24 object-contain transition-all duration-500",style:{transform:o?"scale(1)":"scale(0.9)",opacity:o?1:0}})}),s.jsx("div",{className:"space-y-2",children:s.jsx("p",{className:"text-center leading-relaxed text-gray-700",style:{fontSize:d},children:c})})]})}),s.jsx("button",{onClick:t,className:"relative px-8 py-3 rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-200 hover:-translate-y-0.5 text-white z-50",style:{backgroundColor:"var(--btn-primary-bg)",minWidth:"200px"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--btn-primary-bg-hover)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="var(--btn-primary-bg)"},children:i})]})]}):null},re=({isLoading:e,error:t,currentLang:r})=>{const n=d(r);return t?s.jsxs("div",{style:{position:"fixed",top:"70px",left:"16px",right:"16px",background:"#fee2e2",padding:"12px 16px",borderRadius:"12px",color:"#991b1b",fontSize:"14px",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",alignItems:"flex-start",gap:"12px"},children:[s.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{flexShrink:0,marginTop:"2px"},children:[s.jsx("circle",{cx:"12",cy:"12",r:"10"}),s.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),s.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),s.jsxs("div",{style:{flex:1},children:[s.jsx("strong",{style:{display:"block",marginBottom:"4px"},children:n("locationError")}),s.jsx("span",{children:t})]})]}):e?s.jsxs("div",{style:{position:"fixed",top:"70px",left:"16px",right:"16px",background:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(10px)",padding:"12px 16px",borderRadius:"12px",color:"var(--primary)",fontSize:"14px",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"12px"},children:[s.jsx(h,{size:"sm"}),s.jsxs("div",{style:{flex:1},children:[s.jsx("strong",{style:{display:"block",marginBottom:"2px"},children:n("locatingYou")}),s.jsx("span",{style:{fontSize:"12px",opacity:.8},children:n("pleaseWait")})]}),s.jsxs("div",{style:{display:"flex",gap:"4px",alignItems:"center"},children:[s.jsx("div",{style:{width:"6px",height:"6px",borderRadius:"50%",background:"var(--primary)",animation:"pulse 1.5s ease-in-out infinite"}}),s.jsx("div",{style:{width:"6px",height:"6px",borderRadius:"50%",background:"var(--primary)",animation:"pulse 1.5s ease-in-out 0.3s infinite"}}),s.jsx("div",{style:{width:"6px",height:"6px",borderRadius:"50%",background:"var(--primary)",animation:"pulse 1.5s ease-in-out 0.6s infinite"}})]}),s.jsx("style",{children:"\n            @keyframes pulse {\n              0%, 100% { opacity: 0.3; transform: scale(0.8); }\n              50% { opacity: 1; transform: scale(1.2); }\n            }\n          "})]}):null},ne=()=>{const{lang:o}=M(),l=S(),u=k.useRef(null),m=k.useRef(null),p=o||"en",g=d(p),{pois:j,visitedLocations:C,config:_,markLocationVisited:E,welcomeGuide:z,visiblePOIIds:L}=c(),[R,A]=k.useState(null),[T,O]=k.useState(!1),[P,$]=k.useState(!1),[D,H]=k.useState(!1),[F,G]=k.useState(!1),[W,B]=k.useState(!1),U=k.useRef(void 0),q=k.useRef(null),[Z,Y]=k.useState(!1),[X,K]=k.useState(!1),[J,Q]=k.useState(!1),{setTimeout:ne,clearTimeout:ae}=v();k.useEffect(()=>{const e=new URLSearchParams(window.location.search),t=e.get("completed"),r=e.get("poiId"),n=sessionStorage.getItem("ar-current-poi"),a=sessionStorage.getItem("ar-session-start-ts"),i=(r||n)??null;if(!i||!a)return;const o=Math.max(0,Math.floor((Date.now()-Number(a))/1e3));if(E(i),f(Number(i),o),sessionStorage.removeItem("ar-current-poi"),sessionStorage.removeItem("ar-session-start-ts"),t||r){const e=window.location.pathname;window.history.replaceState({},"",e)}},[E]);const ie=k.useMemo(()=>null==_?void 0:_.geolocation_settings,[null==_?void 0:_.geolocation_settings]),oe=k.useMemo(()=>null==_?void 0:_.map_settings,[null==_?void 0:_.map_settings]),se=k.useMemo(()=>null==_?void 0:_.navigation_settings,[null==_?void 0:_.navigation_settings]),le=k.useMemo(()=>null==_?void 0:_.route_cache_settings,[null==_?void 0:_.route_cache_settings]),ce=k.useMemo(()=>null==_?void 0:_.theme_colors,[null==_?void 0:_.theme_colors]);k.useEffect(()=>{if(!F&&z){const e=ne(()=>{H(!0)},500);return()=>ae(e)}},[F,z,ne,ae]);const de=k.useCallback(()=>{H(!1),G(!0)},[G]),ue=k.useCallback(()=>{H(!0),G(!1)},[G]),{userLocation:me,error:pe}=((a,i,o)=>{const[s,l]=k.useState(null),[c,d]=k.useState(null),[u,m]=k.useState(null),[p,g]=k.useState(null),[h,v]=k.useState(null),[f,x]=k.useState(!1),y=k.useRef(null),b=k.useRef(0),w=(null==o?void 0:o.update_threshold)||10,j=(null==o?void 0:o.enable_high_accuracy)??e.ENABLE_HIGH_ACCURACY,M=(null==o?void 0:o.maximum_age)||e.MAXIMUM_AGE,S=(null==o?void 0:o.timeout)||e.TIMEOUT,N=k.useCallback(()=>new Promise((e,t)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{e(t)},e=>{t(e)},{enableHighAccuracy:!0,maximumAge:0,timeout:3e4}):t(new Error("Geolocation not supported"))}),[]),C=k.useCallback(()=>{null!==y.current&&(navigator.geolocation.clearWatch(y.current),y.current=null)},[]),_=k.useCallback(()=>{if(x(!0),d(null),N().then(e=>{t("üéØ Got initial precise position:",{lat:e.coords.latitude,lng:e.coords.longitude,accuracy:e.coords.accuracy}),e.coords.accuracy>100?r("‚ö†Ô∏è Initial position has low accuracy:",e.coords.accuracy,"meters"):t("‚úÖ Initial position has good accuracy:",e.coords.accuracy,"meters");const n=[e.coords.longitude,e.coords.latitude];l(n),m(e.coords.accuracy),g(e.coords.speed),v(e.coords.heading),d(null),x(!1)}).catch(e=>{r("‚ö†Ô∏è Initial position failed, falling back to watch:",e.message),d(e.message),x(!1)}),"undefined"==typeof window||!navigator.geolocation)return d("Geolocation is not supported by this browser"),void x(!1);if(null!==y.current)return;const e=a=>{const i={enableHighAccuracy:a,maximumAge:0,timeout:a?2e4:1e4};y.current=navigator.geolocation.watchPosition(e=>{if(t("üìç Got position:",{lat:e.coords.latitude,lng:e.coords.longitude,accuracy:e.coords.accuracy,altitude:e.coords.altitude,altitudeAccuracy:e.coords.altitude,heading:e.coords.heading,speed:e.coords.speed,timestamp:new Date(e.timestamp).toISOString()}),e.coords.accuracy>50){if(r("‚ö†Ô∏è Low accuracy detected:",e.coords.accuracy,"meters - requesting higher accuracy"),a){const n={enableHighAccuracy:!0,maximumAge:0,timeout:6e4};return void navigator.geolocation.getCurrentPosition(r=>{if(r.coords.accuracy<=50){t("‚úÖ Got accurate position on retry:",r.coords.accuracy,"meters");const e=[r.coords.longitude,r.coords.latitude];l(e),m(r.coords.accuracy),d(null)}else{const t=[e.coords.longitude,e.coords.latitude];l(t),m(e.coords.accuracy),d(null)}},t=>{r("‚ö†Ô∏è Retry failed, using original position. Error:",t.message);const n=[e.coords.longitude,e.coords.latitude];l(n),m(e.coords.accuracy),d(null)},n)}}else t("‚úÖ Good accuracy:",e.coords.accuracy,"meters");const n=Date.now();if(n-b.current<w&&0!==b.current)return;b.current=n;const i=[e.coords.longitude,e.coords.latitude];l(i),m(e.coords.accuracy),g(e.coords.speed),v(e.coords.heading),d(null)},t=>{if(n("üö® Geolocation error:",{code:t.code,message:t.message,highAccuracy:a}),a)return null!==y.current&&(navigator.geolocation.clearWatch(y.current),y.current=null),void e(!1);let r="";switch(t.code){case t.PERMISSION_DENIED:r="Location permission denied. Please enable location access in your browser settings.";break;case t.POSITION_UNAVAILABLE:r="Location information unavailable. Please check your device settings.";break;case t.TIMEOUT:r="Location request timed out. Please try again.";break;default:r=`Geolocation error: ${t.message}`}d(r),x(!1)},i)};e(j)},[void 0,w,j,M,S]);return k.useEffect(()=>(_(),C),[]),{userLocation:s,error:c,accuracy:u,speed:p,heading:h,isLoading:f,startWatching:_,stopWatching:C}})(0,0,ie),{routeGeoJSON:ge,routeDistance:he,routeTime:ve,fetchRoute:fe,clearRoute:xe,isLoading:ye}=((e,t)=>{const[r,n]=k.useState(null),[o,s]=k.useState(null),[l,c]=k.useState(null),[d,u]=k.useState(!1),[m,p]=k.useState(null),g=k.useRef(new Map),h=k.useRef(null),v=k.useRef(null),f=k.useRef(null),x=k.useRef(0),y=(null==t?void 0:t.duration_ms)||a.DURATION_MS,b=(null==t?void 0:t.max_entries)||a.MAX_ENTRIES,w=i.SNAP_TO_ROUTE_THRESHOLD_KM,j=i.ROUTE_DEVIATION_THRESHOLD_KM,M=k.useCallback((e,t)=>`${e[0].toFixed(4)},${e[1].toFixed(4)}-${t[0].toFixed(4)},${t[1].toFixed(4)}`,[]),S=k.useCallback(()=>{const e=Date.now(),t=g.current;t.forEach((r,n)=>{e-r.timestamp>y&&t.delete(n)}),Array.from(t.values()).some(e=>{const t=I(e.distance,"walking");return Math.abs(e.time-t)>10})&&t.clear(),t.size>b&&Array.from(t.entries()).sort((e,t)=>e[1].timestamp-t[1].timestamp).slice(0,t.size-b).forEach(([e])=>t.delete(e))},[y,b]),N=k.useCallback((e,t)=>{const[r,n]=e,[a,i]=t,o=(i-n)*Math.PI/180,s=(a-r)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(n*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371},[]),C=k.useCallback((e,t)=>{if(!t||!t.geometry.coordinates.length)return null;let r=1/0,n=null;return t.geometry.coordinates.forEach(t=>{const a=N(e,[t[0],t[1]]);a<r&&(r=a,n=[t[0],t[1]])}),r<=w&&n?n:null},[N,w]),_=k.useCallback((e,t)=>{if(!t||!t.geometry.coordinates.length)return!1;let r=1/0;return t.geometry.coordinates.forEach(t=>{if(void 0!==t[0]&&void 0!==t[1]){const n=N(e,[t[0],t[1]]);n<r&&(r=n)}}),r>j},[N,j]),E=k.useCallback(async t=>{if(!e)return void p("User location not available");h.current=t;const r=M(e,t),a=g.current.get(r);if(a&&Date.now()-a.timestamp<y)return n(a.data),s(a.distance),c(a.time),void p(null);v.current&&v.current.abort(),v.current=new AbortController,u(!0),p(null);try{const[a,i]=e,[o,l]=t,d="walking",u=`https://api.mapbox.com/directions/v5/mapbox/${d}/${a},${i};${o},${l}?geometries=geojson&overview=full&steps=true&access_token=pk.eyJ1IjoidHN0YXJvdm9pdG92IiwiYSI6ImNtandvZ3doMTIzanUzZXFzbGw2ODZrczYifQ.H2oaEnsDGD_eR3FA7rvaow`,m=await fetch(u,{signal:v.current.signal});if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);const h=await m.json();if(!h.routes||0===h.routes.length)throw new Error("No route found");const f=h.routes[0],x=f.geometry,y=f.distance/1e3;let b=f.duration/60;b=I(y,d);const w={type:"Feature",properties:{api:"Mapbox",profile:d},geometry:x};g.current.set(r,{key:r,data:w,timestamp:Date.now(),distance:y,time:b}),S(),n(w),s(y),c(b),p(null)}catch(i){if("AbortError"===i.name)return;p(i.message||"Failed to fetch route"),n(null),s(null),c(null)}finally{u(!1),v.current=null}},[e,M,y,S]),z=k.useCallback(()=>{n(null),s(null),c(null),p(null),h.current=null,v.current&&(v.current.abort(),v.current=null)},[]);return k.useEffect(()=>{if(e&&h.current&&(!r||_(e,r))){if(Date.now()-x.current<3e3)return;f.current&&clearTimeout(f.current),f.current=setTimeout(()=>{x.current=Date.now(),E(h.current)},1500)}},[e,r,_,E]),k.useEffect(()=>()=>{v.current&&(v.current.abort(),v.current=null),f.current&&clearTimeout(f.current)},[]),{routeGeoJSON:r,routeDistance:o,routeTime:l,isLoading:d,error:m,fetchRoute:E,clearRoute:z,getSnappedPosition:C,checkDeviation:_}})(me,le),{hasArrived:be,isNavigating:we,startNavigation:ke,stopNavigation:je}=((e,t,r)=>{const[n,a]=k.useState(!1),[o,s]=k.useState(!1),l=k.useRef(null),c=(null==r?void 0:r.arrival_threshold_km)||i.ARRIVAL_THRESHOLD_KM,d=(null==r?void 0:r.check_interval_ms)||i.CHECK_INTERVAL_MS,u=()=>{s(!1),a(!1),l.current&&(clearInterval(l.current),l.current=null)};return k.useEffect(()=>{if(!o||!e||!t)return void(l.current&&(clearInterval(l.current),l.current=null));const r=()=>{if(!e||!t)return;const r=((e,t)=>{const[r,n]=e,[a,i]=t,o=(i-n)*Math.PI/180,s=(a-r)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(n*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371})(e,t.coords)<=c;r&&!n?(a(!0),"vibrate"in navigator&&navigator.vibrate([200,100,200])):!r&&n&&a(!1)};return r(),l.current=setInterval(r,d),()=>{l.current&&(clearInterval(l.current),l.current=null)}},[o,e,t,n,c,d]),k.useEffect(()=>{t||u()},[t]),{hasArrived:n,isNavigating:o,startNavigation:()=>{s(!0),a(!1)},stopNavigation:u}})(me,R,se),Me=be||J;k.useEffect(()=>{const e=!(R||we||P||D);if(void 0!==U.current&&(ae(U.current),U.current=void 0),e)return U.current=ne(()=>{B(!0)},5e3),()=>{void 0!==U.current&&(ae(U.current),U.current=void 0)};B(!1)},[R,we,P,D,ne,ae]),k.useEffect(()=>{if(R||we||P||D)return;const e=()=>{B(!1),void 0!==U.current&&(ae(U.current),U.current=void 0),U.current=ne(()=>{B(!0)},5e3)};return window.addEventListener("pointerdown",e,{capture:!0}),window.addEventListener("touchstart",e,{capture:!0,passive:!0}),window.addEventListener("keydown",e,{capture:!0}),window.addEventListener("wheel",e,{capture:!0,passive:!0}),()=>{window.removeEventListener("pointerdown",e,{capture:!0}),window.removeEventListener("touchstart",e,{capture:!0}),window.removeEventListener("keydown",e,{capture:!0}),window.removeEventListener("wheel",e,{capture:!0})}},[R,we,P,D,ne,ae]);const Se=k.useCallback(e=>{if(t("üéØ handlePOISelection called with:",null==e?void 0:e.name[p]),t("üìç selectedPOI:",null==R?void 0:R.name[p]),!(we&&e&&R&&e.id!==R.id)){if(e){const t="string"==typeof e.id?parseInt(e.id):e.id;x(t,e.name[p]||e.name.en||"Unknown POI","manual")}t("‚úÖ Setting selected POI to:",null==e?void 0:e.name[p]),A(e),Q(!1)}},[we,R,p]),Ne=k.useMemo(()=>j?j.filter(e=>!!e.Has_AR&&(Array.isArray(e.Has_AR)?"Yes"===e.Has_AR[0]||!0===e.Has_AR[0]:"Yes"===e.Has_AR||!0===e.Has_AR)):[],[j]),Ce=k.useMemo(()=>C.filter(e=>Ne.some(t=>t.id===e)).length,[C,Ne]),_e=k.useMemo(()=>j&&L?j.filter(e=>L.includes(e.id)):[],[j,L]);k.useEffect(()=>{const e=l.state;if(!(null==e?void 0:e.selectedPoiId)||!j||!Z)return;const t=String(e.selectedPoiId);if(q.current===t)return;const r=j.find(e=>String(e.id)===t);r&&(q.current=t,window.history.replaceState({},document.title),Se(r),m.current&&m.current.flyTo({center:r.coords,zoom:(null==oe?void 0:oe.navigation_zoom)||y.NAVIGATION_ZOOM,duration:(null==oe?void 0:oe.map_fly)||1e3}))},[l.state,j,Z,oe,Se]);const Ie=k.useCallback((e,t)=>{const[r,n]=e,[a,i]=t,o=(i-n)*Math.PI/180,s=(a-r)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(n*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371},[]),Ee=k.useCallback(()=>{if(!me||!Ne.length)return null;const e=Ne.filter(e=>!C.includes(e.id));if(0===e.length)return null;let t=e[0]||null;if(!t)return null;let r=Ie(me,t.coords);for(let n=1;n<e.length;n++){const a=e[n];if(!a)continue;const i=Ie(me,a.coords);i<r&&(r=i,t=a)}return t},[me,Ne,C,Ie]),ze=k.useCallback((e,r)=>{if(r&&e<=Ce){const r=(e,t)=>String(e)===String(t),n=C.map(e=>Ne.find(t=>r(t.id,e))).filter(e=>Boolean(e))[e-1];if(n)return t("üì± Selecting visited POI for circle:",n.name[p]),je(),xe(),Se(n),Q(!0),void(m.current&&m.current.flyTo({center:n.coords,zoom:(null==oe?void 0:oe.navigation_zoom)||y.NAVIGATION_ZOOM,duration:(null==oe?void 0:oe.map_fly)||1e3}))}Q(!1);const n=Ee();n&&(t("üì± Selecting POI:",n.name[p]),Se(n),m.current&&(t("üó∫Ô∏è Flying to location:",n.coords),m.current.flyTo({center:n.coords,zoom:(null==oe?void 0:oe.navigation_zoom)||y.NAVIGATION_ZOOM,duration:(null==oe?void 0:oe.map_fly)||1e3})))},[Ee,Se,oe,me,Ne,C,Ce,p,je,xe]);k.useEffect(()=>{t("üéØ selectedPOI changed to:",null==R?void 0:R.name[p])},[R,p]),k.useEffect(()=>{if(!u.current||!j||!_)return void r("Map initialization skipped due to missing dependencies",{hasContainer:!!u.current,hasPois:!!j,hasConfig:!!_});const e=new N.Map({container:u.current,style:{version:8,sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:""}},layers:[{id:"background",type:"background",paint:{"background-color":"#f8f8f8"}},{id:"osm",type:"raster",source:"osm",paint:{"raster-opacity":1,"raster-fade-duration":0}}],glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf"},center:(null==oe?void 0:oe.default_center)||y.DEFAULT_CENTER,zoom:(null==oe?void 0:oe.initial_zoom)||y.INITIAL_ZOOM,maxZoom:(null==oe?void 0:oe.max_zoom)||y.MAX_ZOOM,minZoom:(null==oe?void 0:oe.min_zoom)||y.MIN_ZOOM,pitch:0,bearing:0,pitchWithRotate:!1,dragRotate:!1,touchZoomRotate:!0,touchPitch:!1});return m.current=e,e.on("load",()=>{Y(!0),e.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[]}}});const t=(null==ce?void 0:ce.primary)||"#E57300";e.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":9,"line-opacity":.3,"line-blur":2}}),e.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":6,"line-opacity":.9}})}),e.on("error",t=>{t.error&&t.error.message.includes("tile")&&e.setStyle("https://basemaps.cartocdn.com/gl/positron-gl-style/style.json")}),e.on("zoomend",()=>{b("zoom",{zoom_level:e.getZoom()})}),()=>{var e;if(m.current&&"function"==typeof m.current.remove){if(Boolean(null==(e=m.current)?void 0:e._removed));else try{m.current.remove()}catch(t){}m.current=null}Y(!1)}},[j,_,oe,ce]);const Le=k.useCallback(()=>{O(!0),ne(()=>O(!1),100)},[ne]),Re=k.useCallback(()=>{var e;t("üîç MapView handleCardClose called:",{selectedPOIId:null==R?void 0:R.id,selectedPOIName:null==(e=null==R?void 0:R.name)?void 0:e.ca,currentSelectedPOI:R,isNavigating:we}),we&&(xe(),je()),A(null),O(!1)},[xe,je,we,R]);k.useEffect(()=>{const e=m.current;if(!e)return;const t=()=>{if(R){if(be&&!R.has_ar)return we&&(xe(),je()),void Re();Le()}};return e.on("click",t),()=>{e.off("click",t)}},[R,be,Re,we,xe,je,Le]),k.useEffect(()=>{m.current&&me&&Z&&!X&&(m.current.flyTo({center:me,zoom:(null==oe?void 0:oe.initial_zoom)||y.INITIAL_ZOOM,duration:1500}),K(!0))},[me,Z,oe,X]),((e,t,r,n,a,i,o,s)=>{const l=k.useRef(new Map),c=k.useRef(a),d=k.useRef(s);k.useEffect(()=>{c.current=a},[a]),k.useEffect(()=>{d.current=s},[s]),k.useEffect(()=>{const r=e.current;if(r&&t&&0!==t.length&&o)return t.forEach(e=>{if(l.current.has(e.id))return;const t=Number(e.coords[0]),n=Number(e.coords[1]),a=(e=>{var t,r,n,a;const o=document.createElement("div");o.className="map-marker-poi",o.setAttribute("data-poi-id",String(e.id)),o.setAttribute("tabindex","0"),o.setAttribute("role","button"),o.setAttribute("aria-label",e.name[i]||e.name.en||"Location"),o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="50px",o.style.height="60px",o.style.cursor="pointer",o.style.transition="none";const s=document.createElement("img");s.style.width="100%",s.style.height="100%",s.style.objectFit="contain",s.style.display="block",s.style.pointerEvents="none",s.style.userSelect="none",s.draggable=!1,s.alt=(null==(t=e.name)?void 0:t[i])||(null==(r=e.name)?void 0:r.en)||"Location pin";const l=e.pin_background?`https://datacalella.metaversotechnologies.com/assets/${e.pin_background}`:"/calella/images/default-pin.svg",c=e.pin_background_selected?`https://datacalella.metaversotechnologies.com/assets/${e.pin_background_selected}`:l;if(s.src=l,o.setAttribute("data-pin-default",l),o.setAttribute("data-pin-selected",c),o.appendChild(s),e.image){const t=document.createElement("img");t.style.position="absolute",t.style.top="5px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.width="33px",t.style.height="33px",t.style.borderRadius="4px",t.style.objectFit="cover",t.style.pointerEvents="none",t.style.border="2px solid white",t.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.2)",t.style.display="block",t.alt=`${(null==(n=e.name)?void 0:n[i])||(null==(a=e.name)?void 0:a.en)||"Location"} icon`,t.src=`https://datacalella.metaversotechnologies.com/assets/${e.image}`,o.appendChild(t)}return o})(e);a.addEventListener("click",t=>{t.stopPropagation(),d.current||c.current(e)}),a.addEventListener("keydown",t=>{if("Enter"===t.key||" "===t.key){if(t.preventDefault(),t.stopPropagation(),d.current)return;c.current(e)}});const o=new N.Marker({element:a,anchor:"bottom"}).setLngLat([t,n]).addTo(r);l.current.set(e.id,o)}),()=>{l.current.forEach((e,t)=>{"user-location"!==t&&e.remove()}),t.forEach(e=>l.current.delete(e.id))}},[e,t,o,i]),k.useEffect(()=>{l.current.forEach((e,t)=>{if("user-location"===t)return;const r=e.getElement(),a=n&&String(t)===String(n.id);s?(r.style.cursor="not-allowed",r.style.opacity=a?"1":"0.6"):(r.style.cursor="pointer",r.style.opacity="1")})},[s,n]),k.useEffect(()=>{const t=e.current;if(!t||!r||!o)return;let n=l.current.get("user-location");const[a,i]=[Number(r[0]),Number(r[1])];if(n){const e=n.getLngLat(),t={lng:a,lat:i},r=Math.sqrt(Math.pow(t.lng-e.lng,2)+Math.pow(t.lat-e.lat,2));if(r<1e-5)return void n.setLngLat([a,i]);let o=null;const s=Math.min(300,Math.max(100,5e4*r)),l=r=>{o||(o=r);const a=Math.min((r-o)/s,1),i=a<.5?2*a*a:1-Math.pow(-2*a+2,2)/2,c=e.lng+(t.lng-e.lng)*i,d=e.lat+(t.lat-e.lat)*i;n.setLngLat([c,d]),a<1&&requestAnimationFrame(l)};requestAnimationFrame(l)}else{const e=document.createElement("div");e.className="user-location-marker",e.style.position="relative",e.style.width="40px",e.style.height="40px";const r=document.createElement("div");r.style.position="absolute",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.width="40px",r.style.height="40px",r.style.borderRadius="50%",r.style.background="rgba(66, 133, 244, 0.2)",r.style.border="2px solid rgba(66, 133, 244, 0.5)",r.style.animation="pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",e.appendChild(r);const o=document.createElement("div");o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.width="20px",o.style.height="20px",o.style.borderRadius="50%",o.style.backgroundColor="#4285F4",o.style.border="3px solid white",o.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",e.appendChild(o);const s=document.createElement("div");if(s.style.position="absolute",s.style.bottom="50%",s.style.left="50%",s.style.transform="translate(-45%, 0)",s.style.width="29px",s.style.height="76px",s.style.clipPath="polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)",s.style.background="linear-gradient(0deg, rgba(66,133,244,0.62) 0%, rgba(66,133,244,0.14) 55%, rgba(66,133,244,0) 100%)",s.style.filter="drop-shadow(0 1px 2px rgba(0,0,0,0.14))",s.style.borderRadius="0",s.style.maskImage="linear-gradient(to right, transparent 0%, #000 18%, #000 82%, transparent 100%)",s.style.webkitMaskImage="linear-gradient(to right, transparent 0%, #000 18%, #000 82%, transparent 100%)",s.style.transformOrigin="50% 100%",s.style.transition="transform 0.25s ease-out, opacity 0.25s ease-out",s.style.opacity="0.9",e.appendChild(s),"DeviceOrientationEvent"in window){let t=0,r=0;const n=.08;let a=0,i=null;i=e=>{let i=null;if(void 0!==e.webkitCompassHeading?i=e.webkitCompassHeading:null!==e.alpha&&null!==e.beta&&null!==e.gamma&&!0===e.absolute&&(i=360-e.alpha),null!==i&&i>=0&&i<=360){const e=Date.now();if(e-a<80)return;a=e,i=(i%360+360)%360;let o=i-r;o>180&&(o-=360),o<-180&&(o+=360),r=(r+o*n)%360,r<0&&(r+=360),Math.abs(r-t)>1.2&&(s.style.transform=`translate(-45%, 0) rotate(${r}deg)`,t=r)}},"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e&&i&&window.addEventListener("deviceorientation",i,!0)}).catch(e=>{}):window.addEventListener("deviceorientation",i,!0),e._orientationHandler=i}n=new N.Marker({element:e,anchor:"center",rotationAlignment:"viewport"}).setLngLat([a,i]).addTo(t),l.current.set("user-location",n)}return()=>{const e=l.current.get("user-location");e&&(e.remove(),l.current.delete("user-location"))}},[e,r,o]),k.useEffect(()=>{l.current.forEach((e,t)=>{if("user-location"===t)return;const r=e.getElement(),a=r.querySelector("img"),i=n&&String(t)===String(n.id);if(r.setAttribute("aria-pressed",i?"true":"false"),r.style.zIndex=i?"10":"1",!a)return;const o=r.getAttribute("data-pin-default"),s=r.getAttribute("data-pin-selected");s&&(a.src=i?s:o||"")})},[n])})(m,_e,me,R,Se,p,Z,we),k.useEffect(()=>{if(!m.current||!ge)return;const e=m.current.getSource("route");e&&e.setData(ge)},[ge]),k.useEffect(()=>{if(!m.current||ge)return;const e=m.current.getSource("route");e&&e.setData({type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[]}})},[ge]);const Ae=k.useCallback(()=>{R&&me?(fe(R.coords),ke(),m.current&&oe&&m.current.flyTo({center:me,zoom:oe.navigation_zoom||y.NAVIGATION_ZOOM,duration:oe.map_fly||1e3})):alert("Waiting for your location... Please allow location access in your browser.")},[R,me,fe,ke,oe]),Te=k.useCallback(()=>{xe(),je()},[xe,je]),Oe=k.useCallback(()=>{m.current&&me&&(m.current.flyTo({center:me,zoom:(null==oe?void 0:oe.initial_zoom)||y.INITIAL_ZOOM,duration:(null==oe?void 0:oe.map_fly)||800}),b("recenter_on_user"))},[me,oe]);if(!j)return s.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",background:"#F3F3F9"},children:s.jsx("div",{style:{textAlign:"center"},children:s.jsx(h,{size:"lg",showLabel:!0,label:"Loading map..."})})});const Pe=!R&&!we&&!D&&Ne.length>0;return s.jsxs("div",{className:"map-wrapper",style:{width:"100%",height:"100vh",position:"relative",overflow:"hidden"},children:[s.jsx("div",{ref:u,className:"map-container",style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:1,width:"100%",height:"100%"}}),z&&s.jsx(te,{isOpen:D,onClose:de,characterName:z.character_name,characterImageUrl:z.character_image_url,welcomeText:z.translations[p]||z.translations.en||"",buttonText:g("continueButton")}),s.jsx("button",{onClick:()=>$(!P),className:"menu-button","aria-label":g(P?"closeMenu":"openMenu"),type:"button",style:{zIndex:100},children:P?s.jsx("svg",{width:"14",height:"14",viewBox:"0 0 14 14",fill:"none",children:s.jsx("path",{d:"M1 1l12 12M13 1L1 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}):s.jsx("svg",{width:"18",height:"12",viewBox:"0 0 18 12",fill:"none",children:s.jsx("path",{d:"M0 0h18v2H0V0zm0 5h18v2H0V5zm0 5h18v2H0v-2z",fill:"currentColor"})})}),!P&&s.jsx(s.Fragment,{children:s.jsx("button",{onClick:Oe,className:"recenter-button","aria-label":"Center on my location",type:"button",disabled:!me,children:s.jsxs("svg",{className:"recenter-button__icon",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",children:[s.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor"}),s.jsx("circle",{cx:"12",cy:"12",r:"7",stroke:"currentColor",strokeWidth:"1.5",opacity:"0.6"})]})})}),s.jsx(w,{currentLang:p,isOpen:P,onClose:()=>$(!1),onHelp:ue}),W&&s.jsxs("div",{role:"status","aria-live":"polite","aria-atomic":"true",onClick:()=>B(!1),style:{position:"fixed",left:"50%",transform:"translateX(-50%)",bottom:Pe?"calc(220px + env(safe-area-inset-bottom, 0px))":"calc(24px + env(safe-area-inset-bottom, 0px))",zIndex:1300,background:"rgba(255, 255, 255, 0.96)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"16px",padding:"14px 20px",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",fontSize:"15px",fontWeight:"500",color:"#1f2937",textAlign:"center",maxWidth:"85vw",width:"max-content",minWidth:"200px",cursor:"pointer",userSelect:"none",WebkitUserSelect:"none",animation:"idleHelperSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)",border:"1px solid rgba(0, 0, 0, 0.06)"},children:[s.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",style:{flexShrink:0},children:[s.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:(null==ce?void 0:ce.primary)||"#E57300",strokeWidth:"2",fill:"none"}),s.jsx("path",{d:"M12 8v4l3 3",stroke:(null==ce?void 0:ce.primary)||"#E57300",strokeWidth:"2",strokeLinecap:"round"})]}),s.jsx("span",{children:g("tapPointToStart")})]}),R&&s.jsx(V,{poi:R,currentLang:p,onClose:Re,isNavigating:we,hasArrived:Me,navigationDistance:he??null,navigationTime:ve??null,onStartRoute:Ae,onCancelRoute:Te,onMinimize:()=>O(!1),externalMinimize:T,isLoading:ye}),Pe&&s.jsx(ee,{visitedCount:Ce,totalCount:Ne.length,currentLang:p,onCircleClick:ze}),s.jsx(re,{isLoading:!me&&!pe,error:pe,currentLang:p})]})};export{ne as MapView};
